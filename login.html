<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eraya - Login / Sign Up</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="auth-body">

    <!-- LOGIN PANEL -->
    <div class="auth-card" id="loginPanel">
        <div class="auth-form-side">
            <div class="auth-brand">
                <img src="images/logo.png" alt="Eraya Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline'">
                <span style="display:none">Eraya</span>
            </div>
            <h2>Welcome to ERAYA</h2>
            <p>Your personalized menstrual wellness companion</p>

            <div class="auth-field">
                <label for="loginEmail">Email Address</label>
                <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email">
            </div>
            <div class="auth-field">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="••••••••" autocomplete="current-password">
            </div>
            <div class="auth-row">
                <label><input type="checkbox" id="rememberMe"> Remember me</label>
                <a href="#" class="auth-forgot">Forgot password?</a>
            </div>
            <button id="loginBtn" class="auth-btn" type="button" onclick="handleLogin()">Login</button>
            <div class="auth-switch">
                Don't have an account? <a onclick="showSignup()">Sign up</a>
            </div>
        </div>
        <div class="auth-illustration-side">
            <img src="images/holding-flowers.png" alt="Wellness illustration" onerror="this.style.opacity='0'">
            <h3>Track Your Wellness</h3>
            <p>Understand your cycle, empower your health journey</p>
        </div>
    </div>

    <!-- SIGNUP PANEL -->
    <div class="auth-card auth-hidden" id="signupPanel">
        <div class="auth-form-side">
            <div class="auth-brand">
                <img src="images/logo.png" alt="Eraya Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline'">
                <span style="display:none">Eraya</span>
            </div>
            <h2>Create Account</h2>
            <p>Start your wellness journey today</p>

            <div class="auth-field">
                <label for="signupName">Full Name</label>
                <input type="text" id="signupName" placeholder="Your full name">
            </div>
            <div class="auth-field">
                <label for="signupEmail">Email Address</label>
                <input type="email" id="signupEmail" placeholder="your@email.com">
            </div>
            <div class="auth-field">
                <label for="signupPassword">Password</label>
                <input type="password" id="signupPassword" placeholder="Create a password (min 6 chars)">
            </div>
            <div class="auth-field">
                <label for="signupConfirm">Confirm Password</label>
                <input type="password" id="signupConfirm" placeholder="Confirm your password">
            </div>
            <button id="signupBtn" class="auth-btn" type="button" onclick="handleSignup()">Create Account</button>
            <div class="auth-switch">
                Already have an account? <a onclick="showLogin()">Login</a>
            </div>
        </div>
        <div class="auth-illustration-side">
            <img src="images/holding-flowers.png" alt="Wellness illustration" onerror="this.style.opacity='0'">
            <h3>Join ERAYA</h3>
            <p>Thousands of women trust ERAYA for their wellness journey</p>
        </div>
    </div>

    <script>
        function safeParseObject(rawValue) {
            if (!rawValue) return {};
            try {
                const parsed = JSON.parse(rawValue);
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch (_err) {
                return {};
            }
        }

        function getSafeNextPath() {
            const params = new URLSearchParams(window.location.search);
            const next = (params.get('next') || '').trim();
            if (!next) return '';
            if (next.startsWith('http://') || next.startsWith('https://') || next.startsWith('//')) return '';
            if (next.startsWith('javascript:')) return '';
            return next;
        }

        function shouldOpenSignupFirst() {
            const params = new URLSearchParams(window.location.search);
            return (params.get('intent') || '').toLowerCase() === 'signup';
        }

        function setButtonBusy(buttonId, busy) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            button.disabled = busy;
            button.style.opacity = busy ? '0.75' : '1';
            button.style.cursor = busy ? 'not-allowed' : '';
        }

        function callApiWithTimeout(url, method, payload, timeoutMs) {
            const controller = new AbortController();
            const timer = setTimeout(function() { controller.abort(); }, timeoutMs || 8000);
            return fetch(url, {
                method: method,
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload || {}),
                signal: controller.signal
            }).finally(function() {
                clearTimeout(timer);
            });
        }

        async function callApi(url, method, payload) {
            const response = await callApiWithTimeout(url, method, payload, 8000);

            let data = {};
            try {
                data = await response.json();
            } catch (_err) {
                data = {};
            }

            if (!response.ok) {
                throw new Error(data.error || 'Request failed. Please try again.');
            }
            return data;
        }

        function inferSetupDone(existing, normalized) {
            const storedProfile = safeParseObject(localStorage.getItem('userData'));
            const perUserProfiles = safeParseObject(localStorage.getItem('userDataByEmail'));
            return Boolean(existing.setupDone) ||
                (storedProfile && storedProfile.email === normalized.email && Boolean(storedProfile.setupComplete)) ||
                (perUserProfiles[normalized.email] && Boolean(perUserProfiles[normalized.email].setupComplete));
        }

        function syncLocalUser(user, isNewSignup) {
            if (!user || !user.email) return;

            const normalized = {
                email: user.email,
                name: user.name || user.email.split('@')[0]
            };
            localStorage.setItem('erayaUser', JSON.stringify(normalized));

            const users = safeParseObject(localStorage.getItem('erayaUsers'));
            const existing = users[normalized.email] || {};
            const inferredSetupDone = inferSetupDone(existing, normalized);
            const setupDone = isNewSignup ? false : inferredSetupDone;
            users[normalized.email] = {
                ...existing,
                email: normalized.email,
                name: normalized.name,
                setupDone: setupDone
            };
            localStorage.setItem('erayaUsers', JSON.stringify(users));
            return { user: normalized, setupDone: setupDone };
        }

        function legacyLocalLogin(email, password) {
            const users = safeParseObject(localStorage.getItem('erayaUsers'));
            const keys = Object.keys(users);
            const matchKey = keys.find(function(key) {
                return String(key).toLowerCase() === String(email).toLowerCase();
            });
            if (!matchKey) return null;
            const candidate = users[matchKey];
            if (!candidate || typeof candidate.password !== 'string') return null;
            if (candidate.password !== password) return null;

            const normalized = {
                email: candidate.email || matchKey,
                name: candidate.name || (candidate.email || matchKey).split('@')[0]
            };
            localStorage.setItem('erayaUser', JSON.stringify(normalized));
            const setupDone = inferSetupDone(candidate, normalized);
            users[normalized.email] = {
                ...candidate,
                email: normalized.email,
                name: normalized.name,
                setupDone: setupDone
            };
            localStorage.setItem('erayaUsers', JSON.stringify(users));
            return { user: normalized, setupDone: setupDone };
        }

        function legacyLocalSignup(name, email, password) {
            const users = safeParseObject(localStorage.getItem('erayaUsers'));
            const keys = Object.keys(users);
            const exists = keys.some(function(key) {
                return String(key).toLowerCase() === String(email).toLowerCase();
            });
            if (exists) {
                throw new Error('An account with this email already exists');
            }

            users[email] = {
                email: email,
                name: name,
                password: password,
                setupDone: false
            };
            localStorage.setItem('erayaUsers', JSON.stringify(users));
            localStorage.setItem('erayaUser', JSON.stringify({ email: email, name: name }));
            return { user: { email: email, name: name }, setupDone: false };
        }

        function showSignup() {
            document.getElementById('loginPanel').classList.add('auth-hidden');
            document.getElementById('signupPanel').classList.remove('auth-hidden');
        }

        function showLogin() {
            document.getElementById('signupPanel').classList.add('auth-hidden');
            document.getElementById('loginPanel').classList.remove('auth-hidden');
        }

        async function handleLogin() {
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn && loginBtn.disabled) return;

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            setButtonBusy('loginBtn', true);
            try {
                const data = await callApi('/api/login', 'POST', {
                    email: email,
                    password: password
                });
                const user = data && data.user ? data.user : null;
                if (!user || !user.email) {
                    throw new Error('Login succeeded but user session was invalid.');
                }
                syncLocalUser(user, false);
                const target = getSafeNextPath() || 'index.html';
                showToast('Welcome back!', 'success');
                setTimeout(function() {
                    window.location.href = target;
                }, 900);
            } catch (err) {
                const fallback = legacyLocalLogin(email, password);
                if (fallback) {
                    const target = getSafeNextPath() || 'index.html';
                    showToast('Logged in (offline mode).', 'success');
                    setTimeout(function() {
                        window.location.href = target;
                    }, 900);
                } else {
                    showToast(err.message || 'Login failed', 'error');
                }
            } finally {
                setButtonBusy('loginBtn', false);
            }
        }

        async function handleSignup() {
            const signupBtn = document.getElementById('signupBtn');
            if (signupBtn && signupBtn.disabled) return;

            const name     = document.getElementById('signupName').value.trim();
            const email    = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirm  = document.getElementById('signupConfirm').value;

            if (!name || !email || !password || !confirm) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            if (password !== confirm) {
                showToast('Passwords do not match', 'error');
                return;
            }

            setButtonBusy('signupBtn', true);
            try {
                const data = await callApi('/api/register', 'POST', {
                    name: name,
                    email: email,
                    password: password
                });
                const user = data && data.user ? data.user : { email: email, name: name };
                syncLocalUser(user, true);
                showToast('Account created! Let us set up your profile.', 'success');
                setTimeout(function() {
                    window.location.href = getSafeNextPath() || 'setup.html';
                }, 900);
            } catch (err) {
                try {
                    legacyLocalSignup(name, email, password);
                    showToast('Account created (offline mode). Let us set up your profile.', 'success');
                    setTimeout(function() {
                        window.location.href = getSafeNextPath() || 'setup.html';
                    }, 900);
                } catch (localErr) {
                    showToast(err.message || localErr.message || 'Registration failed', 'error');
                }
            } finally {
                setButtonBusy('signupBtn', false);
            }
        }

        function showToast(message, type) {
            const existing = document.querySelector('.auth-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'auth-toast';
            toast.style.cssText =
                'position:fixed;top:24px;right:24px;' +
                'background:' + (type === 'error' ? '#FF6B9D' : '#4ECDC4') + ';' +
                'color:white;padding:14px 22px;border-radius:12px;font-size:15px;' +
                'font-weight:600;box-shadow:0 6px 20px rgba(0,0,0,0.2);z-index:99999;';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(function() { if (toast.parentNode) toast.remove(); }, 3500);
        }

        (function hydratePrefill() {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            if (rememberedEmail) {
                const emailInput = document.getElementById('loginEmail');
                const rememberMe = document.getElementById('rememberMe');
                if (emailInput) emailInput.value = rememberedEmail;
                if (rememberMe) rememberMe.checked = true;
            }
        })();

        document.getElementById('loginBtn').addEventListener('click', function() {
            const rememberMe = document.getElementById('rememberMe');
            const emailInput = document.getElementById('loginEmail');
            if (rememberMe && emailInput) {
                if (rememberMe.checked && emailInput.value.trim()) {
                    localStorage.setItem('rememberedEmail', emailInput.value.trim());
                } else {
                    localStorage.removeItem('rememberedEmail');
                }
            }
        });

        ['loginEmail', 'loginPassword'].forEach(function(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleLogin();
                }
            });
        });

        ['signupName', 'signupEmail', 'signupPassword', 'signupConfirm'].forEach(function(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleSignup();
                }
            });
        });

        if (shouldOpenSignupFirst()) {
            showSignup();
        }
    </script>
</body>
</html>
